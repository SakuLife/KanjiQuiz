name: KanjiQuiz Automation

on:
  schedule:
    # æ¯Žæ—¥ 17:00 JST (08:00 UTC) ã«å®Ÿè¡Œ - 20:00äºˆç´„æŠ•ç¨¿ã®ãŸã‚
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if already executed today'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'nul'

env:
  TZ: Asia/Tokyo

# GitHub Actionsã®æ¨©é™è¨­å®š
permissions:
  contents: read
  actions: read

jobs:
  video-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # å®Œå…¨å®Ÿè¡Œã®ãŸã‚60åˆ†ã«å»¶é•·

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        sudo apt-get install -y fonts-noto-cjk
        sudo apt-get install -y xvfb
        sudo apt-get install -y p7zip-full

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install VOICEVOX Engine
      run: |
        echo "ðŸ“¦ VOICEVOX Engine v0.24.1 ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹..."
        cd /tmp
        wget https://github.com/VOICEVOX/voicevox_engine/releases/download/0.24.1/voicevox_engine-linux-cpu-x64-0.24.1.7z.001
        echo "ðŸ“‚ VOICEVOX Engineã®è§£å‡ä¸­..."
        7z x voicevox_engine-linux-cpu-x64-0.24.1.7z.001
        chmod +x linux-cpu-x64/run
        ls -la linux-cpu-x64/
        echo "âœ… VOICEVOX Engine ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
        echo "VOICEVOX_ENGINE_PATH=/tmp/linux-cpu-x64/run" >> $GITHUB_ENV

    - name: Setup environment variables
      run: |
        echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> $GITHUB_ENV
        echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
        echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV
        echo "YT_CLIENT_ID=${{ secrets.YT_CLIENT_ID }}" >> $GITHUB_ENV
        echo "YT_CLIENT_SECRET=${{ secrets.YT_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "YT_REFRESH_TOKEN=${{ secrets.YT_REFRESH_TOKEN }}" >> $GITHUB_ENV

    - name: Create required directories
      run: |
        mkdir -p json
        mkdir -p logs
        mkdir -p video
        mkdir -p voice
        mkdir -p temp

    - name: Setup Google Service Account
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import json
        
        # Secretsã‹ã‚‰JSONã‚’å–å¾—
        gcp_sa_json = os.environ.get('GCP_SA_JSON', '')
        
        if not gcp_sa_json or gcp_sa_json == 'null':
            print("âŒ GCP_SA_JSON ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            exit(1)
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã¿
        try:
            # ã¾ãšJSONã¨ã—ã¦æ¤œè¨¼
            json_data = json.loads(gcp_sa_json)
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
            os.makedirs('json', exist_ok=True)
            with open('json/credentials.json', 'w', encoding='utf-8') as f:
                json.dump(json_data, f, indent=2, ensure_ascii=False)
            
            os.chmod('json/credentials.json', 0o600)
            print("âœ… Google Service Accountèªè¨¼æƒ…å ±ã‚’é…ç½®ã—ã¾ã—ãŸ")
            print("âœ… JSONå½¢å¼ã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ")
        except json.JSONDecodeError as e:
            print(f"âŒ credentials.jsonãŒç„¡åŠ¹ãªJSONå½¢å¼ã§ã™: {e}")
            print("ðŸ’¡ ãƒ’ãƒ³ãƒˆ: GCP_SA_JSONã«ã¯ã€credentials.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹å…¨ä½“ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„")
            print(f"ðŸ“ æœ€åˆã®100æ–‡å­—: {gcp_sa_json[:100]}")
            exit(1)
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            exit(1)
        PYTHON_SCRIPT
      env:
        GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}

    - name: Setup YouTube OAuth
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import json
        
        # Secretsã‹ã‚‰JSONã‚’å–å¾—
        yt_client_secret_json = os.environ.get('YT_CLIENT_SECRET_JSON', '')
        
        if not yt_client_secret_json or yt_client_secret_json == 'null':
            print("âŒ YT_CLIENT_SECRET_JSON ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            exit(1)
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã¿
        try:
            # ã¾ãšJSONã¨ã—ã¦æ¤œè¨¼
            json_data = json.loads(yt_client_secret_json)
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
            os.makedirs('json', exist_ok=True)
            with open('json/client_secret.json', 'w', encoding='utf-8') as f:
                json.dump(json_data, f, indent=2, ensure_ascii=False)
            
            os.chmod('json/client_secret.json', 0o600)
            print("âœ… YouTube OAuthèªè¨¼æƒ…å ±ã‚’é…ç½®ã—ã¾ã—ãŸ")
            print("âœ… JSONå½¢å¼ã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ")
        except json.JSONDecodeError as e:
            print(f"âŒ client_secret.jsonãŒç„¡åŠ¹ãªJSONå½¢å¼ã§ã™: {e}")
            print("ðŸ’¡ ãƒ’ãƒ³ãƒˆ: YT_CLIENT_SECRET_JSONã«ã¯ã€client_secret.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹å…¨ä½“ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„")
            print(f"ðŸ“ æœ€åˆã®100æ–‡å­—: {yt_client_secret_json[:100]}")
            exit(1)
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            exit(1)
        PYTHON_SCRIPT
      env:
        YT_CLIENT_SECRET_JSON: ${{ secrets.YT_CLIENT_SECRET_JSON }}

    - name: Setup YouTube Token Pickle
      run: |
        if [ -z "${{ secrets.YOUTUBE_TOKEN_PICKLE }}" ]; then
          echo "âš ï¸  YOUTUBE_TOKEN_PICKLE ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "âš ï¸  YouTubeèªè¨¼ã¯åˆå›žå®Ÿè¡Œæ™‚ã«æ‰‹å‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™"
          exit 0
        fi
        echo "ðŸ“ YouTubeèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­..."
        # base64æ–‡å­—åˆ—ã‹ã‚‰æ”¹è¡Œã¨ç©ºç™½ã‚’å‰Šé™¤
        TOKEN_B64=$(echo "${{ secrets.YOUTUBE_TOKEN_PICKLE }}" | tr -d '\n\r\t ')
        if [ -z "$TOKEN_B64" ]; then
          echo "âŒ YOUTUBE_TOKEN_PICKLE ãŒç©ºã§ã™"
          exit 1
        fi
        # base64ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        if echo "$TOKEN_B64" | base64 -d > token.pickle 2>/dev/null; then
          if [ -f token.pickle ] && [ -s token.pickle ]; then
            chmod 600 token.pickle
            FILE_SIZE=$(stat -c%s token.pickle 2>/dev/null || stat -f%z token.pickle 2>/dev/null || echo "unknown")
            echo "âœ… YouTubeèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é…ç½®ã—ã¾ã—ãŸ ($FILE_SIZE bytes)"
          else
            echo "âŒ token.pickleãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰"
            exit 1
          fi
        else
          echo "âŒ base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ðŸ’¡ ãƒ’ãƒ³ãƒˆ: YOUTUBE_TOKEN_PICKLEã¯ã€encode_token.pyã§ç”Ÿæˆã—ãŸBase64æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"
          exit 1
        fi

    - name: Send start notification
      continue-on-error: true
      run: |
        python -c "
        import os, requests, datetime
        webhook_url = os.environ.get('DISCORD_WEBHOOK_URL', '')
        if webhook_url:
            now = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
            message = {
                'content': f'ðŸš€ **KanjiQuizè‡ªå‹•ç”Ÿæˆé–‹å§‹**\né–‹å§‹æ™‚åˆ»: {now.strftime(\"%Y-%m-%d %H:%M JST\")}\nå®Ÿè¡Œç’°å¢ƒ: GitHub Actions'
            }
            requests.post(webhook_url, json=message)
        "

    - name: Run KanjiQuiz automation
      id: quiz_generation
      continue-on-error: true
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        python run_quiz_bot.py --github-actions
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Upload artifacts on success
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kanji-quiz-video-${{ github.run_number }}
        path: |
          video/*.mp4
          video/*_thumbnail.jpg
          logs/*.log
        retention-days: 7

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: kanji-quiz-logs-failed-${{ github.run_number }}
        path: |
          logs/*.log
          temp/*.log
        retention-days: 7

    - name: Send completion notification
      if: always()
      continue-on-error: true
      run: |
        python -c "
        import os, requests, datetime
        webhook_url = os.environ.get('DISCORD_WEBHOOK_URL', '')
        if webhook_url:
            now = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
            status = 'âœ… æˆåŠŸ' if '${{ steps.quiz_generation.outcome }}' == 'success' else 'âŒ å¤±æ•—'
            message = {
                'content': f'ðŸ“º **KanjiQuizè‡ªå‹•ç”Ÿæˆå®Œäº†**\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {status}\nå®Œäº†æ™‚åˆ»: {now.strftime(\"%Y-%m-%d %H:%M JST\")}\nå®Ÿè¡ŒID: ${{ github.run_number }}'
            }
            requests.post(webhook_url, json=message)
        "

  metrics-collection:
    runs-on: ubuntu-latest
    needs: video-generation
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup environment variables
      run: |
        echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" >> $GITHUB_ENV
        echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV
        echo "YT_CLIENT_ID=${{ secrets.YT_CLIENT_ID }}" >> $GITHUB_ENV
        echo "YT_CLIENT_SECRET=${{ secrets.YT_CLIENT_SECRET }}" >> $GITHUB_ENV
        echo "YT_REFRESH_TOKEN=${{ secrets.YT_REFRESH_TOKEN }}" >> $GITHUB_ENV

    - name: Setup Google Service Account
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import json
        
        gcp_sa_json = os.environ.get('GCP_SA_JSON', '')
        
        if not gcp_sa_json or gcp_sa_json == 'null':
            print("âŒ GCP_SA_JSON ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            exit(1)
        
        try:
            json_data = json.loads(gcp_sa_json)
            os.makedirs('json', exist_ok=True)
            with open('json/credentials.json', 'w', encoding='utf-8') as f:
                json.dump(json_data, f, indent=2, ensure_ascii=False)
            os.chmod('json/credentials.json', 0o600)
            print("âœ… Google Service Accountèªè¨¼æƒ…å ±ã‚’é…ç½®ã—ã¾ã—ãŸ")
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
            exit(1)
        PYTHON_SCRIPT
      env:
        GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}

    - name: Setup YouTube OAuth
      run: |
        python3 << 'PYTHON_SCRIPT'
        import os
        import json
        
        yt_client_secret_json = os.environ.get('YT_CLIENT_SECRET_JSON', '')
        
        if not yt_client_secret_json or yt_client_secret_json == 'null':
            print("âŒ YT_CLIENT_SECRET_JSON ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            exit(1)
        
        try:
            json_data = json.loads(yt_client_secret_json)
            os.makedirs('json', exist_ok=True)
            with open('json/client_secret.json', 'w', encoding='utf-8') as f:
                json.dump(json_data, f, indent=2, ensure_ascii=False)
            os.chmod('json/client_secret.json', 0o600)
            print("âœ… YouTube OAuthèªè¨¼æƒ…å ±ã‚’é…ç½®ã—ã¾ã—ãŸ")
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
            exit(1)
        PYTHON_SCRIPT
      env:
        YT_CLIENT_SECRET_JSON: ${{ secrets.YT_CLIENT_SECRET_JSON }}

    - name: Run metrics collection
      continue-on-error: true
      run: |
        python core/reporter.py --github-actions
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: Send metrics notification
      if: always()
      continue-on-error: true
      run: |
        python -c "
        import os, requests, datetime
        webhook_url = os.environ.get('DISCORD_WEBHOOK_URL', '')
        if webhook_url:
            now = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
            message = {
                'content': f'ðŸ“Š **ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†å®Œäº†**\nå®Œäº†æ™‚åˆ»: {now.strftime(\"%Y-%m-%d %H:%M JST\")}'
            }
            requests.post(webhook_url, json=message)
        "
